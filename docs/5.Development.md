# 开发指南

本文档提供 FastAPI-Vue3-Sample 项目的开发指南，包括开发流程、编码规范、项目结构和扩展方法。

## 开发环境设置

### 前提条件

- **Python 环境**：推荐使用 pyenv 管理 Python 版本
- **包管理**：使用 PDM 管理 Python 依赖
- **前端环境**：使用 Bun 作为 JavaScript 运行时和包管理器
- **数据库**：PostgreSQL 数据库
- **IDE/编辑器**：推荐 VS Code，可配置 Python 和 Vue 插件

### 环境配置步骤

1. **设置 Python 环境**

```bash
# 安装指定 Python 版本
pyenv install 3.12
pyenv local 3.12
```

2. **安装 PDM 并设置项目依赖**

```bash
# 安装 PDM
pip install pdm

# 安装项目依赖
pdm install

# 安装开发依赖
pdm install -d
```

3. **安装 Bun 并设置前端环境**

```bash
# 安装 Bun
curl -fsSL https://bun.sh/install | bash

# 安装前端依赖
bun install
```

4. **设置 PostgreSQL 数据库**

```bash
# 创建数据库
createdb fastapi_vue3_sample

# 配置环境变量
cp .env.example .env
# 修改 .env 中的数据库连接信息
```

## 开发工作流程

### 后端开发流程

1. **创建新功能**

   - 在 `app/models/` 中定义数据库模型
   - 在 `app/schemas/` 中定义 Pydantic 模型
   - 在 `app/routes/` 中实现 API 端点

2. **运行开发服务器**

   ```bash
   pdm run dev
   ```

3. **访问 API 文档**
   - 打开浏览器访问 `http://localhost:8000/docs`
   - 测试 API 端点功能

### 前端开发流程

1. **创建新组件**

   - 在 `frontend/components/` 中添加 Vue 组件
   - 在 `frontend/services/` 中添加 API 服务

2. **运行开发服务器**

   ```bash
   bun run dev
   ```

3. **构建生产版本**
   ```bash
   bun run build
   ```

### 数据库迁移

当前项目使用 SQLAlchemy ORM 管理数据库架构，如需添加数据库迁移支持，可使用 Alembic：

```bash
# 安装 Alembic
pdm add alembic

# 初始化 Alembic
alembic init migrations

# 创建迁移
alembic revision --autogenerate -m "描述变更内容"

# 应用迁移
alembic upgrade head
```

## 编码规范

### Python 编码规范

1. **PEP 8 规范**

   - 使用 4 个空格缩进
   - 每行最大长度 88 字符
   - 使用空行分隔函数和类
   - 使用双引号表示字符串

2. **导入顺序**

   ```python
   # 标准库导入
   import os
   import sys

   # 第三方库导入
   from fastapi import FastAPI

   # 本地模块导入
   from app.models import UserModel
   ```

3. **函数和方法命名**

   - 使用小写字母和下划线命名函数和方法：`get_user_by_id`
   - 使用描述性名称，避免缩写

4. **类命名**

   - 使用驼峰命名法：`UserModel`
   - 模型名称应以 `Model` 结尾
   - Pydantic 模型使用描述性名称：`UserCreate`, `UserUpdate`

5. **注释和文档字符串**
   - 为所有公共函数、方法和类添加文档字符串
   - 使用 Google 风格的文档字符串

```python
def get_user_by_id(user_id: int) -> UserModel:
    """根据 ID 获取用户。

    Args:
        user_id: 用户的唯一标识符。

    Returns:
        UserModel: 用户对象。

    Raises:
        HTTPException: 如果用户不存在。
    """
```

### Vue 编码规范

1. **组件命名**

   - 使用 PascalCase 命名组件：`ProductList.vue`
   - 文件名应与组件名匹配

2. **组件结构**

   - 使用组合式 API (Composition API)
   - 遵循 `<script setup>`, `<template>`, `<style>` 顺序

3. **CSS 命名**

   - 使用小写字母和连字符命名 CSS 类：`product-list`
   - 避免使用 ID 选择器
   - 可使用 scoped 样式隔离组件样式

4. **代码格式化**
   - 使用 2 个空格缩进
   - 在适当位置使用空行增加可读性

## 项目结构和扩展

### 后端结构

```
app/
├── configs/         # 配置文件
├── database/        # 数据库相关代码
├── models/          # 数据库模型
├── routes/          # API 路由
└── schemas/         # Pydantic 模型
```

### 如何添加新功能

1. **添加新模型**

在 `app/models/` 中创建新的数据模型：

```python
from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from app.database.utils import Base

class CategoryModel(Base):
    __tablename__ = "categories"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False)
    description = Column(String(500), nullable=True)

    # 关系定义
    products = relationship("ProductModel", back_populates="category")
```

2. **添加 Pydantic 模型**

在 `app/schemas/` 中定义 Pydantic 模型：

```python
from pydantic import BaseModel
from typing import Optional, List

class CategoryBase(BaseModel):
    name: str
    description: Optional[str] = None

class CategoryCreate(CategoryBase):
    pass

class Category(CategoryBase):
    id: int

    class Config:
        orm_mode = True
```

3. **添加 API 路由**

在 `app/routes/` 中创建新的路由文件：

```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.database.utils import get_db
from app.models.category import CategoryModel
from app.schemas.category import CategoryCreate, Category

router = APIRouter(prefix="/api/categories", tags=["categories"])

@router.get("", response_model=List[Category])
async def get_categories(db: Session = Depends(get_db)):
    """获取所有分类"""
    categories = db.query(CategoryModel).all()
    return categories

# 添加其他 CRUD 操作...
```

4. **注册路由**

在 `app/routes/__init__.py` 中注册新路由：

```python
from app.routes import category
from app import app

app.include_router(category.router)
```

### 前端结构

```
frontend/
├── components/      # Vue 组件
└── services/        # API 服务
```

### 如何添加新组件

1. **创建 API 服务**

在 `frontend/services/api.js` 中添加新的 API 服务：

```javascript
// 分类 API 服务
export const categoryApi = {
  // 获取所有分类
  getCategories() {
    return apiClient.get("/categories");
  },

  // 添加其他 CRUD 操作...
};
```

2. **创建 Vue 组件**

在 `frontend/components/` 中创建新的组件：

```vue
<script setup>
import { ref, onMounted } from "vue";
import { categoryApi } from "../services/api";

// 状态
const categories = ref([]);
const loading = ref(false);
const error = ref(null);

// 加载数据
const fetchCategories = async () => {
  loading.value = true;
  try {
    const response = await categoryApi.getCategories();
    categories.value = response.data;
  } catch (err) {
    error.value = "加载分类失败: " + err.message;
  } finally {
    loading.value = false;
  }
};

onMounted(() => {
  fetchCategories();
});
</script>

<template>
  <div class="categories-container">
    <h1>分类管理</h1>

    <!-- 内容 -->
  </div>
</template>
```

## 测试策略

### 后端测试

使用 pytest 进行后端测试：

```bash
# 安装测试依赖
pdm add pytest pytest-asyncio httpx -d

# 创建测试目录
mkdir -p tests/api
```

示例测试文件 `tests/api/test_product.py`：

```python
from fastapi.testclient import TestClient
import pytest
from app import app

client = TestClient(app)

def test_get_products():
    response = client.get("/api/products")
    assert response.status_code == 200
    data = response.json()
    assert isinstance(data, list)
```

运行测试：

```bash
pytest
```

### 前端测试

使用 Vitest 进行前端测试：

```bash
# 安装测试依赖
bun add -d vitest @vue/test-utils

# 创建测试目录
mkdir -p frontend/__tests__
```

示例测试文件 `frontend/__tests__/ProductList.test.js`：

```javascript
import { mount } from "@vue/test-utils";
import { describe, it, expect } from "vitest";
import ProductList from "../components/ProductList.vue";

describe("ProductList", () => {
  it("renders properly", () => {
    const wrapper = mount(ProductList);
    expect(wrapper.find("h1").text()).toContain("产品管理");
  });
});
```

运行测试：

```bash
bun run test
```

## 版本控制和协作

### Git 工作流

推荐使用 GitHub Flow 工作流：

1. 从 `main` 分支创建功能分支
2. 进行开发和提交
3. 创建 Pull Request
4. 代码审查
5. 合并到 `main` 分支

### 提交规范

使用结构化的提交消息：

```
<类型>(<范围>): <描述>

[可选的正文]

[可选的脚注]
```

类型包括：

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更改
- `style`: 代码格式修改
- `refactor`: 代码重构
- `test`: 添加或修改测试
- `chore`: 构建过程或辅助工具的变动

例如：

```
feat(product): 添加产品分类功能

- 添加分类数据模型
- 实现分类 API
- 创建分类管理界面
```

## 调试技巧

### 后端调试

1. **使用 FastAPI 的调试模式**

   - 默认情况下，`uvicorn main:app --reload` 会启用调试模式
   - 错误会显示完整的堆栈跟踪

2. **日志记录**
   - 使用 Python 的 `logging` 模块记录信息
   - 配置适当的日志级别

```python
import logging

logger = logging.getLogger(__name__)
logger.setLevel(logging.DEBUG)

logger.debug("调试信息")
logger.info("普通信息")
logger.warning("警告信息")
logger.error("错误信息")
```

### 前端调试

1. **Vue DevTools**

   - 安装 Vue DevTools 浏览器扩展
   - 在开发模式下查看组件树和状态

2. **浏览器开发者工具**

   - 使用 Console 查看日志和错误
   - 使用 Network 面板查看 API 请求
   - 使用 Vue 面板检查组件

3. **日志调试**
   - 使用 `console.log`, `console.warn`, `console.error` 记录信息
   - 在开发环境中设置断点

## 性能优化

### 后端优化

1. **数据库优化**

   - 为常用查询添加索引
   - 优化 ORM 查询，避免 N+1 问题
   - 使用数据库连接池

2. **API 响应优化**
   - 使用异步处理请求
   - 实现缓存机制
   - 使用适当的分页和筛选

### 前端优化

1. **构建优化**

   - 使用代码分割减小包体积
   - 合理配置打包工具
   - 启用生产模式构建

2. **渲染性能**
   - 避免不必要的组件重渲染
   - 使用 `v-once` 渲染静态内容
   - 使用虚拟滚动处理大列表
