# 部署指南

本文档详细介绍 FastAPI-Vue3-Sample 项目的部署方式，包括本地开发环境、Docker 容器化部署和生产环境部署。

## 本地开发环境

### 前提条件

- Python 3.12+
- PDM 包管理工具
- Bun (JavaScript 运行时和包管理器)
- PostgreSQL 数据库

### 步骤

1. **克隆代码库**

```bash
git clone https://github.com/yourusername/fastapi-vue3-sample.git
cd fastapi-vue3-sample
```

2. **安装后端依赖**

```bash
pdm install
```

3. **设置环境变量**

复制 `.env.example` 文件为 `.env` 并根据实际情况修改配置：

```bash
cp .env.example .env
```

主要配置项：

- `DATABASE_URL`: PostgreSQL 连接字符串
- `SECRET_KEY`: 应用密钥
- `DEBUG`: 调试模式开关

4. **安装前端依赖**

```bash
bun install
```

5. **启动开发服务器**

运行后端服务：

```bash
pdm run dev
```

运行前端开发服务：

```bash
bun run dev
```

6. **访问应用**

打开浏览器访问：

- 后端 API: http://localhost:8000
- API 文档: http://localhost:8000/docs
- 前端应用: http://localhost:3000 (如果前端单独运行)

## Docker 容器化部署

### 前提条件

- Docker
- Docker Compose

### 使用 Docker Compose 部署

1. **克隆代码库**

```bash
git clone https://github.com/yourusername/fastapi-vue3-sample.git
cd fastapi-vue3-sample
```

2. **配置环境变量**

复制并修改环境变量文件：

```bash
cp .env.example .env
```

3. **构建并启动容器**

```bash
docker-compose up -d
```

这将启动：

- Web 应用容器（FastAPI + Vue3）
- PostgreSQL 数据库容器

4. **访问应用**

打开浏览器访问：

- 应用: http://localhost:8000
- API 文档: http://localhost:8000/docs

5. **查看日志**

```bash
docker-compose logs -f
```

6. **停止服务**

```bash
docker-compose down
```

### 单独使用 Dockerfile

如果只需要构建应用容器（不包括数据库），可以使用：

```bash
# 构建镜像
docker build -t fastapi-vue3-app .

# 运行容器
docker run -p 8000:8000 -e DATABASE_URL=postgresql://username:password@host:port/dbname fastapi-vue3-app
```

## 生产环境部署

### 推荐配置

- 云服务器或 VPS
- Nginx 反向代理
- PostgreSQL 数据库服务
- Uvicorn/Gunicorn 作为 WSGI/ASGI 服务器

### 部署步骤

1. **准备服务器**

设置服务器并安装必要软件：

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装依赖
sudo apt install -y python3 python3-pip postgresql nginx

# 安装 Docker（可选，如果使用容器部署）
curl -fsSL https://get.docker.com | sh
```

2. **设置应用**

克隆代码并安装依赖：

```bash
git clone https://github.com/yourusername/fastapi-vue3-sample.git
cd fastapi-vue3-sample

# 安装 PDM
pip install pdm

# 安装依赖
pdm install --prod
```

3. **构建前端**

安装 Bun 并构建前端：

```bash
# 安装 Bun
curl -fsSL https://bun.sh/install | bash

# 安装依赖并构建
bun install
bun run build
```

4. **配置环境变量**

创建生产环境变量文件：

```bash
cp .env.example .env
# 编辑 .env 文件设置生产环境配置
```

5. **配置 Nginx**

创建 Nginx 配置文件：

```
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

启用配置并重启 Nginx：

```bash
sudo ln -s /etc/nginx/sites-available/fastapi-vue3 /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

6. **设置 Systemd 服务**

创建服务文件 `/etc/systemd/system/fastapi-vue3.service`：

```
[Unit]
Description=FastAPI Vue3 Sample
After=network.target

[Service]
User=username
WorkingDirectory=/path/to/fastapi-vue3-sample
Environment="PATH=/path/to/fastapi-vue3-sample/.venv/bin"
EnvironmentFile=/path/to/fastapi-vue3-sample/.env
ExecStart=/path/to/fastapi-vue3-sample/.venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000

[Install]
WantedBy=multi-user.target
```

启动并启用服务：

```bash
sudo systemctl start fastapi-vue3
sudo systemctl enable fastapi-vue3
```

7. **设置 HTTPS（推荐）**

使用 Let's Encrypt 和 Certbot 配置 HTTPS：

```bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

## 使用云平台部署

### Heroku 部署

1. **创建 Procfile**

项目已包含 `Procfile`：

```
web: uvicorn main:app --host=0.0.0.0 --port=${PORT:-8000}
```

2. **部署到 Heroku**

```bash
# 安装 Heroku CLI
curl https://cli-assets.heroku.com/install.sh | sh

# 登录
heroku login

# 创建应用
heroku create fastapi-vue3-sample

# 添加 PostgreSQL 插件
heroku addons:create heroku-postgresql:hobby-dev

# 推送代码
git push heroku main

# 打开应用
heroku open
```

### 其他云平台

项目也适合部署到其他云平台，如：

- AWS Elastic Beanstalk
- Google Cloud Run
- Azure App Service
- Digital Ocean App Platform

请参照各平台的具体部署文档进行操作。

## 持续集成/持续部署 (CI/CD)

项目已配置 GitHub Actions，实现代码提交后自动测试和部署：

- `.github/workflows/` 目录包含 CI/CD 配置
- 支持自动运行测试
- 可配置自动部署至生产/开发环境

## 常见问题解决

### 数据库连接问题

如果遇到数据库连接问题：

- 确认数据库服务正在运行
- 检查 `.env` 文件中的 `DATABASE_URL` 配置
- 确认数据库用户权限设置正确

### 静态文件未正确加载

如果静态文件加载有问题：

- 确认 `dist` 目录中存在构建后的文件
- 检查 Nginx 配置是否正确处理静态文件
- 验证构建命令 `bun run build` 是否成功执行

### 容器无法启动

如果 Docker 容器启动失败：

- 检查 Docker 和 Docker Compose 安装是否正确
- 查看容器日志寻找错误信息：`docker-compose logs`
- 确认 Dockerfile 和 docker-compose.yml 文件配置正确
